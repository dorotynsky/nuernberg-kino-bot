name: Monitor Cinema Programs

on:
  # Run every day at 9:00 AM UTC (10:00 CET in winter, 11:00 CEST in summer)
  schedule:
    - cron: '0 9 * * *'

  # Allow manual trigger from GitHub UI
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: latest
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Load cached dependencies
        id: cached-poetry-dependencies
        uses: actions/cache@v3
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ hashFiles('**/poetry.lock') }}

      - name: Install dependencies
        if: steps.cached-poetry-dependencies.outputs.cache-hit != 'true'
        run: poetry install --no-interaction --no-root

      - name: Restore state from previous run
        uses: actions/cache/restore@v3
        with:
          path: state/
          key: cinema-monitoring-state-${{ github.run_id }}
          restore-keys: |
            cinema-monitoring-state-
            meisengeige-state-  # Fallback for migration

      - name: Run monitoring script
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: poetry run python -m src.main

      - name: Save state for next run
        uses: actions/cache/save@v3
        if: always()
        with:
          path: state/
          key: cinema-monitoring-state-${{ github.run_id }}
